const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./CodeField-1.0.43-BUmVyqpR.js","./cm-1.0.43-BIThoEwM.js","./redux-1.0.43-X9ShETON.js","./vendor-1.0.43-CN03Eozo.js","./index-1.0.43-Br_nYvvF.js","./iconBase-1.0.43-BkINToSh.js","./Typography-1.0.43-CjHjtdZs.js","./lib-1.0.43-GM4CAPbj.js","./loglevel-1.0.43-BZ7XahX3.js","./lodash-1.0.43-BGoSrRk7.js","./moment-1.0.43-C5S46NFB.js","./useEnhancedEffect-1.0.43-DcXwKdLb.js","./notistack-1.0.43-CFZ1B9cW.js","./ConfirmDialog-1.0.43-HyVPTU5U.js","./AdminTheme-1.0.43-CqjS-p3h.js","./Spinner-1.0.43-YmZqinVQ.js","./FormControlLabel-1.0.43-DhLqIzQC.js","./useFormControl-1.0.43-D7bmEJOO.js","./Switch-1.0.43-DUXi6nEm.js","./SwitchBase-1.0.43-jxlYBoq8.js","./useControlled-1.0.43-DObA-A1B.js"])))=>i.map(i=>d[i]);
import{j as e}from"./cm-1.0.43-BIThoEwM.js";import{r as h}from"./redux-1.0.43-X9ShETON.js";import{ap as ae,o as le,q as ce,p as ee,M as pe,x as de,Z as ue,l as H}from"./index-1.0.43-Br_nYvvF.js";import{C as me,a as G,b as Q}from"./ComponentColumn-1.0.43-D990A9j6.js";import{a as I,u as te}from"./hooks-1.0.43-Bzf6s8gj.js";import{u as he}from"./useApp-1.0.43-trge1ckI.js";import{l as f,aY as xe,S as fe,bp as ne,w as je,ce as ge,cf as be,x as F,bw as T,n as Ce,a as R}from"./lib-1.0.43-GM4CAPbj.js";import{_ as ye}from"./main-1.0.43.js";import{q as Se,r as _e}from"./index-1.0.43-CvTha0tS.js";import{u as U}from"./useFormUpdater-1.0.43-Bm7_S2c3.js";import{D as Te}from"./DefaultWhere-1.0.43-Drctlfv9.js";import{B as p}from"./Spinner-1.0.43-YmZqinVQ.js";import{F as M,a as O}from"./FormHelperText-1.0.43-BbvxPfFT.js";import{I as Z,T as Ae}from"./TextField-1.0.43-DsZQBbKY.js";import{S as K}from"./Select-1.0.43-CISjJoqC.js";import{M as X}from"./MenuItem-1.0.43-Uicrp-o6.js";import{T as E}from"./Tooltip-1.0.43-Dw3sfo8K.js";import{I as Y}from"./iconBase-1.0.43-BkINToSh.js";import{L as J}from"./Link-1.0.43-CsQWhuI0.js";import{l as we,m as ve,n as Re}from"./ActionsApp-1.0.43-BtCNZ6dp.js";import{e as w}from"./notistack-1.0.43-CFZ1B9cW.js";import{T as Me,a as B}from"./ToggleButtonGroup-1.0.43-y6Kkgg0C.js";import{S as ze,a as Ne,b as Fe}from"./Stepper-1.0.43-D51mbVNg.js";import{S as Oe}from"./StepContent-1.0.43-DA0As2PG.js";import{B as N,C as ke}from"./ConfirmDialog-1.0.43-HyVPTU5U.js";import{u as De}from"./useMetadata-1.0.43-5v27HTeK.js";import{u as Ie,C as We}from"./useFormDetails-1.0.43-D5LxUh_w.js";import{u as qe}from"./useRemoveAppFromStore-1.0.43-BZ2w6e3F.js";import{P as Be}from"./PremiumFeature-1.0.43-BD8gtQwD.js";import{T as Ee}from"./Typography-1.0.43-CjHjtdZs.js";import{A as Ye,a as Je}from"./AccordionSummary-1.0.43-CNpHbZtu.js";import{A as Ue}from"./AccordionDetails-1.0.43-C8u8mZhB.js";const ie=r=>{const d=I();return h.useCallback((n,x)=>{we({app_id:n.app.app[0].app_id,cnt_id:n.app.container[0].cnt_id},c=>{var g;const j=c==null?void 0:c.data;if(f.debug("response data",j),Array.isArray(j)){const S=((g=xe.getSelectors().selectFormState(fe.getState().forms,r))==null?void 0:g.details)??[];f.debug(S);for(let y=0;y<j.length;y++){const t=ne(j[y]);if(t!==null&&t.cnt_id_master===n.app.container[0].cnt_id){const i=S.filter(b=>b.container.cnt_id===j[y].cnt_id);if(i.length===0){const b={appId:je(),container:j[y]};d(ge({appId:r,detail:b}))}else{const v={appId:i[0].appId,container:j[y]};d(be({appId:r,detail:v}))}}}}else f.error("error loading details",c),x!==void 0&&x()},c=>{f.error("error loading details",c),x!==void 0&&x()})},[r])},Pe=r=>{const d=te(n=>{var x,c;return(c=(x=n.forms[r])==null?void 0:x.form)==null?void 0:c.detailDisplayType});return f.debug("detailDisplayType",d),d},Le=h.lazy(()=>ye(()=>import("./CodeField-1.0.43-BUmVyqpR.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20]),import.meta.url)),$=({appId:r,app:d,relationship:n,metaData:x,isRelationTable:c})=>{f.debug(r,d,n,x);const j=I(),g=U(r),[S,y]=h.useState(n.sql!==void 0&&n.sql!==""),[t,i]=h.useState(c?n.relationJoins.split(",").map(u=>{const l=u.split("=");return{masterColumn:l[0],detailColumn:l[1]??""}}):n.joins.split(",").map(u=>{const l=u.split("=");return{masterColumn:l[0],detailColumn:l[1]??""}}));f.debug("joins",t),h.useEffect(()=>{const u={...n};c?u.relationJoins=t.map(l=>l.masterColumn+"="+l.detailColumn).join(","):u.joins=t.map(l=>l.masterColumn+"="+l.detailColumn).join(","),j(F({property:"relationshipWizard",propertyValue:u})),g(!0)},[t]);const b=c?n.tbl:x.app.container[0].cnt_tbl,v=c?n.cls:x.app.container[0].cnt_cls===void 0||x.app.container[0].cnt_cls===null||x.app.container[0].cnt_cls===""?{}:JSON.parse(x.app.container[0].cnt_cls),k=c?d.appRelationTable:d.appTable,D=c?d.appRelationColumns:d.appColumns;return e.jsxs(p,{children:[...t.map((u,l)=>e.jsxs(p,{sx:{display:"grid",marginTop:"10px"},children:[e.jsxs(p,{sx:{display:"grid",gridTemplateColumns:"minmax(0, 1fr) 20px minmax(0, 1fr) auto",alignItems:"center"},children:[e.jsxs(M,{children:[e.jsx(Z,{variant:"outlined",children:"master *"}),e.jsxs(K,{MenuProps:{id:"pp-select-menu"},label:"master *",value:u.masterColumn,onChange:m=>{const _=[...t];_[l].masterColumn=m.target.value,i(_),g(!0)},children:[...v.map(m=>m.isSelected?e.jsxs(X,{value:m.columnName,children:[b,".",m.columnName]}):null)]})]}),e.jsx(p,{sx:{textAlign:"center"},children:"="}),e.jsxs(M,{children:[e.jsx(Z,{variant:"outlined",children:"detail *"}),e.jsxs(K,{MenuProps:{id:"pp-select-menu"},label:"detail *",value:u.detailColumn,onChange:m=>{const _=[...t];_[l].detailColumn=m.target.value,i(_),g(!0)},children:[...D.map(m=>m.isSelected?e.jsxs(X,{value:m.columnName,children:[k,".",m.columnName]}):null)]})]}),e.jsx(p,{children:l===0?e.jsx(E,{title:"Add condition",children:e.jsx(Y,{color:"primary",onClick:()=>{const m=[...t];m.push({masterColumn:"",detailColumn:""}),i(m),g(!0)},children:e.jsx(Se,{})})}):e.jsx(E,{title:"Delete condition",children:e.jsx(Y,{color:"primary",onClick:()=>{const m=[...t];m.splice(l,1),i(m),g(!0)},children:e.jsx(_e,{})})})})]}),e.jsx(p,{children:e.jsx(M,{children:e.jsx(O,{children:"Updating requires a table reload."})})})]})),e.jsx(p,{sx:{marginTop:"20px"},children:S?e.jsxs(M,{fullWidth:!0,children:[e.jsx(h.Suspense,{children:e.jsx(Le,{code:c?n.relationSql:n.sql,setCode:u=>{const l={...n};c?l.relationSql=u:l.sql=u,j(F({property:"relationshipWizard",propertyValue:l})),g(!0)},dialogTitle:"Optional conditions",extension:"sql"})}),e.jsx(Te,{})]}):e.jsxs(J,{onClick:()=>y(!0),sx:{textDecoration:"none",cursor:"pointer",display:"flex",alignItems:"center",gap:"5px"},children:[e.jsx(ae,{}),e.jsx("span",{children:"Add SQL conditions"})]})}),n.cardinality===T.ONE_TO_ONE&&e.jsx(p,{sx:{marginTop:"20px"},children:e.jsx(M,{fullWidth:!0,children:e.jsx(O,{children:"A join for a 1:1 relationship must return exactly one record. An error is shown when a detail query returns more than 1 record."})})})]})},Ve=()=>{const r=te(d=>d.apps.relationshipWizard);return f.debug("relationship",r),r},He=({appId:r,metaData:d,isUpdating:n,initialRelationships:x,initialTitle:c,embedded:j,enableWizard:g})=>{const S=I(),y=ie(r),t=he(),i=Ve(),b=U(r),[v,k]=h.useState(j);f.debug("typeSelected",v),h.useEffect(()=>{const s={...i};s.title=t.appTitle??"",s.dbs=t.appDatabase??"",s.tbl=t.appTable??"",s.cls=t.appColumns,s.relationTbl=t.appRelationTable??"",s.relationCls=t.appRelationColumns,S(F({property:"relationshipWizard",propertyValue:s}))},[t.appDatabase,t.appTable,t.appRelationTable,t.appColumns,t.appRelationColumns,t.appTitle]);const[D,u]=h.useState(""),l=h.useMemo(()=>i.cardinality===T.MANY_TO_MANY?["Relationship title","Select join table","Define join table join condition","Select relation table","Define relation table join condition"]:["Relationship title","Select data source","Define join condition"],[i.cardinality]),[m,_]=h.useState(0),W=s=>{switch(f.debug(s),s){case 0:if(t.appTitle===""||t.appTitle===null||c!==t.appTitle&&x.filter(o=>o.title===t.appTitle).length>0)return u("title"),!1;u("");break;case 1:if(t.appDatabase===""||t.appDatabase===null||t.appTable===""||t.appTable===null||t.appColumns.filter(o=>o.isSelected===!0).length===0)return!1;u("");break;case 2:if(i.joins==="=")return!1;u("");break;case 3:if(t.appRelationColumns.filter(o=>o.isSelected===!0).length===0)return!1;u("");break;case 4:if(i.relationJoins==="=")return!1;u("");break}return!0},A=s=>(f.debug(s),e.jsxs(p,{sx:{display:"grid",gridTemplateColumns:"1fr 1fr",justifyContent:"space-between",alignItems:"center",gap:"5px"},children:[s===0?e.jsx(p,{}):e.jsx(N,{variant:"contained",startIcon:e.jsx(le,{}),onClick:()=>{_(s-1)},children:"Previous"}),s===2&&i.cardinality!==T.MANY_TO_MANY||s===4&&i.cardinality===T.MANY_TO_MANY?e.jsx(N,{variant:"contained",startIcon:e.jsx(ce,{}),onClick:()=>{W(s)&&_(s+1)},children:"Finish"}):e.jsx(N,{variant:"contained",endIcon:e.jsx(ee,{}),onClick:()=>{W(s)&&_(s+1)},children:"Next"})]}));return v?e.jsxs(e.Fragment,{children:[e.jsx(ze,{activeStep:m,orientation:"vertical",sx:{marginBottom:0},children:l.map((s,o)=>e.jsxs(Ne,{children:[e.jsx(Fe,{children:s}),e.jsx(Oe,{children:e.jsxs(p,{sx:{display:"flex",flexDirection:"column",gap:"20px",marginTop:"20px"},children:[o===0&&e.jsxs(e.Fragment,{children:[e.jsx(Ae,{type:"text",label:"Title",error:D==="title",value:t.appTitle,fullWidth:!0,required:!0,helperText:"Container title (must be unique witin this form)",autoComplete:"off",onChange:a=>{S(Ce({property:{appTitle:a.target.value}}));const z={...i};z.title=a.target.value,S(F({property:"relationshipWizard",propertyValue:z})),b(!0)}}),A(o)]}),o===1&&e.jsxs(e.Fragment,{children:[e.jsx(me,{}),e.jsx(G,{isDetail:!0}),e.jsx(Q,{app:t}),A(o)]}),o===2&&e.jsxs(e.Fragment,{children:[e.jsx($,{appId:r,app:t,metaData:d,relationship:i}),A(o)]}),i.cardinality===T.MANY_TO_MANY&&o===3&&e.jsxs(e.Fragment,{children:[e.jsx(G,{isDetail:!0,isRelationTable:!0}),e.jsx(Q,{app:t,isRelationTable:!0}),A(o)]}),i.cardinality===T.MANY_TO_MANY&&o===4&&e.jsxs(e.Fragment,{children:[e.jsx($,{appId:r,app:t,metaData:d,relationship:i,isRelationTable:!0}),A(o)]})]})})]},s))}),m===l.length&&e.jsxs(p,{sx:{marginTop:"20px",display:"grid",gap:"20px"},children:[e.jsx(p,{children:"Relationship wizard successfully completed. Click button below to activate."}),e.jsx(N,{fullWidth:!0,variant:"contained",onClick:()=>{const s={app_id:d.app.container[0].app_id,app_title:i.title,app_dbs:i.dbs,app_tbl:i.tbl,app_cls:i.cls},o={cnt_id_master:d.app.container[0].cnt_id,cardinality:i.cardinality,join_condition:i.joins,sql:i.sql};i.cardinality===T.MANY_TO_MANY&&(o.relation_tbl=i.relationTbl,o.relation_cls=i.relationCls,o.relation_join_condition=i.relationJoins,o.relation_sql=i.relationSql),s.app_relation=JSON.stringify(o),n?(s.app_cnt=t.appCntId,Re(s,a=>{f.debug(a),(a==null?void 0:a.code)==="ok"&&(a==null?void 0:a.message)===""?(g(!1),w("Relationship updated",{variant:"success"}),y(d,()=>{w(R.contactSupport,{variant:"error"})}),b(!1)):w(R.contactSupport,{variant:"error"})},a=>{f.error(a),w(R.contactSupport,{variant:"error"})},!1)):ve(s,a=>{f.debug(a),(a==null?void 0:a.code)==="ok"&&(a==null?void 0:a.message)===""?(g(!1),w("Relationship created",{variant:"success"}),y(d,()=>{w(R.contactSupport,{variant:"error"})}),b(!1)):w(R.contactSupport,{variant:"error"})},a=>{f.error(a),w(R.contactSupport,{variant:"error"})},!1)},children:n?"Update relationship":"Create relationship"})]})]}):e.jsx(p,{children:e.jsxs(M,{fullWidth:!0,children:[e.jsxs(Me,{fullWidth:!0,color:"primary",exclusive:!0,value:i.cardinality,onChange:(s,o)=>{if(o!==null){const a={...i};a.cardinality=o,S(F({property:"relationshipWizard",propertyValue:a}))}b(!0),k(!0)},children:[e.jsx(B,{value:T.ONE_TO_ONE,children:"1:1"}),e.jsx(B,{value:T.ONE_TO_MANY,children:"1:m"}),e.jsx(B,{value:T.MANY_TO_MANY,children:"m:m"})]}),e.jsx(O,{children:"Select cardinality."})]})})},Ge=({children:r,appId:d,embedded:n,enableWizard:x})=>{const c=U(d),j=()=>e.jsxs(p,{children:[e.jsx(p,{sx:{paddingTop:"30px"},children:r}),e.jsx(E,{title:"Close",sx:{position:"absolute",top:0,right:"8px"},children:e.jsx(Y,{onClick:()=>{x(!1),c(!1)},children:e.jsx(pe,{})})})]});return n?e.jsxs(p,{sx:{marginLeft:"-10px",marginRight:"-10px",position:"relative"},children:[e.jsx(Ee,{component:"div",sx:{height:"40px",display:"flex",alignItems:"center",marginBottom:"-10px"},children:"Relationship Wizard"}),j()]}):e.jsx(p,{children:e.jsxs("fieldset",{className:"pp-fieldset",style:{position:"relative"},children:[e.jsx("legend",{children:"Relationship Wizard"}),j()]})})},vt=({appId:r,updateSettings:d})=>{var z;f.debug(r),I(),qe(),Pe(r);const n=Ie(r);We(),ie(r);const[x,c]=h.useState(!1);f.debug("wizardOn",x);const[j,g]=h.useState(!1);f.debug("wizardIsUpdating",j);const[S,y]=h.useState("");f.debug("wizardTitle",S);const t=De(r);f.debug(t);const[i,b]=h.useState([]);f.debug(i),h.useEffect(()=>{var L,V;const P=[];if(n!==void 0&&n.length>0&&((L=t==null?void 0:t.app)==null?void 0:L.container)!==void 0&&Array.isArray((V=t==null?void 0:t.app)==null?void 0:V.container)){const se=t.app.container[0].cnt_id,re=t.app.container[0].cnt_tbl;for(let C=0;C<n.length;C++){const q=ne(n[C].container);if(q!==null&&q.cnt_id_master===se){const oe=n[C].appId;P.push({appId:oe,dbAppId:n[C].container.app_id,cntId:n[C].container.cnt_id,title:n[C].container.cnt_title,dbs:n[C].container.cnt_dbs,tbl:n[C].container.cnt_tbl,cls:n[C].container.cnt_cls===void 0||n[C].container.cnt_cls===null||n[C].container.cnt_cls===""?{}:JSON.parse(n[C].container.cnt_cls),relation:q,parentTbl:re})}}}b(P)},[r,(z=t==null?void 0:t.app)==null?void 0:z.container,n]);const[v,k]=h.useState(""),[D,u]=h.useState(-1),[l,m]=h.useState(!1),[_,W]=h.useState(""),[A,s]=h.useState(!1),[o,a]=h.useState(!1);return e.jsxs(e.Fragment,{children:[e.jsxs(Ye,{defaultExpanded:!1,disableGutters:!0,children:[e.jsx(Je,{expandIcon:e.jsx(de,{}),children:"Relationships"}),e.jsxs(Ue,{children:[e.jsx(p,{sx:{marginBottom:"30px"},children:x?e.jsx(e.Fragment,{children:!j&&e.jsx(Ge,{appId:r,embedded:!1,enableWizard:c,children:e.jsx(He,{appId:r,embedded:!1,metaData:t,isUpdating:j,enableWizard:c,initialRelationships:i,initialTitle:""})})}):e.jsx(N,{variant:"contained",fullWidth:!0,disabled:!0,startIcon:e.jsx(ue,{}),endIcon:e.jsx(ee,{}),onClick:()=>{},children:"Start relationship wizard"})}),!1,e.jsx(e.Fragment,{children:!1}),e.jsxs(O,{component:"div",sx:{marginTop:"30px"},children:[e.jsxs(J,{sx:{textDecoration:"none",cursor:"pointer",display:"inline-flex","& svg":{fontSize:"1rem",marginRight:"2px"}},onClick:()=>s(!A),children:[e.jsx(H,{}),"How to use the relationship wizard?"]}),A&&e.jsxs(p,{sx:{marginTop:"20px",marginBottom:"30px",display:"grid",gap:"20px"},children:[e.jsx(p,{children:"The following relationship types are supported:"}),e.jsxs("ul",{style:{listStyle:"disc",padding:"0 40px"},children:[e.jsx("li",{children:"one to one relationship (1:1)"}),e.jsx("li",{children:"one to many relationship (1:m)"}),e.jsx("li",{children:"many to many relationship (m:m)"})]}),e.jsxs(p,{children:["To add a relationship, click the ",e.jsx("strong",{children:"start relationship wizard"})," button and follow the instructions. Relationships are added to the bottom of the form. Use the display type to define how relationships are displayed (possible values are: ",e.jsx("strong",{children:"Accordion"}),", ",e.jsx("strong",{children:"Tabs"})," or ",e.jsx("strong",{children:"Titles"}),")."]})]})]}),e.jsxs(O,{component:"div",children:[e.jsxs(J,{sx:{textDecoration:"none",cursor:"pointer",display:"inline-flex","& svg":{fontSize:"1rem",marginRight:"2px"}},onClick:()=>a(!o),children:[e.jsx(H,{}),"How to create a multi level master detail form?"]}),o&&e.jsx(p,{sx:{marginTop:"20px",display:"grid",gap:"20px"},children:e.jsxs(p,{children:["Add a ",e.jsx("strong",{children:"relationship"})," to the ",e.jsx("strong",{children:"master table"})," using the ",e.jsx("strong",{children:"relationship wizard"}),". Open the ",e.jsx("strong",{children:"detail table"}),". Open the ",e.jsx("strong",{children:"Table Builder"})," from the ",e.jsx("strong",{children:"detail table"})," or navigate to the ",e.jsx("strong",{children:"detail form"})," to open the ",e.jsx("strong",{children:"Form Builder"}),". The buttons to access the ",e.jsx("strong",{children:"Table Builders"})," and ",e.jsx("strong",{children:"Form Builders"})," are available in the footer. Open the ",e.jsx("strong",{children:"Relationships"})," section and start the ",e.jsx("strong",{children:"relationship wizard"}),"."]})})]}),e.jsx(Be,{})]})]}),l&&e.jsx(ke,{title:"Delete Relationship?",message:"Are you sure you want to delete this relationship? This action cannot be undone!",open:l,setOpen:m,onConfirm:()=>{}})]})};export{vt as S,ie as U};
